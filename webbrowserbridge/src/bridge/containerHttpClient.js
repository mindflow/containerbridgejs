import { Logger, Method } from "coreutil_v1";
import { ContainerHttpResponse } from "./containerHttpResponse";
import { ContainerUploadData } from "./containerUploadData";
import { ContainerDownload } from "./containerDownload";

const LOG = new Logger("ContainerHttpClient");

export class ContainerHttpClient {

    /**
     * 
     * @param {String} url 
     * @param {Object} params 
     * @param {Number} timeout
     * @return {Promise<ContainerHttpResponse>}
     */
    static async fetch(url, params, timeout = 4000) {
        const responsePromise = fetch(url, params)
        return ContainerHttpResponse._fromResponse(responsePromise, timeout);
    }

    /**
     * 
     * @param {String} method
     * @param {String} url 
     * @param {ContainerUploadData} containerUploadData 
     * @param {Method} progressCallbackMethod 
     * @param {Number} timeout 
     * @returns 
     */
    static async upload(method, url, containerUploadData, authentication = null, progressCallbackMethod = null, timeout = 4000) {

        const xhr = new XMLHttpRequest();
        xhr.open(method, url, true);
        xhr.timeout = timeout;
        xhr.setRequestHeader("Accept", "application/json");
        if (authentication) {
            xhr.setRequestHeader("Authorization", authentication);
        }
        xhr.onprogress = (event) => {
            progressCallbackMethod.call([Math.round((event.loaded / event.total) * 100)]);
        };
        xhr.ontimeout = () => {
            return Promise.reject("Request timed out");
        };

        const formData = containerUploadData._asFormData();
        xhr.send(formData);
        return ContainerHttpResponse._fromXhr(xhr, progressCallbackMethod);
    }

    /**
     * 
     * @param {String} url 
     * @param {Object} params 
     * @param {Number} timeout
     * @returns {Promise<ContainerDownload>}
     */
    static async download(url, params, timeout = 4000) {
        const response = await fetch(url, params);
        const blob = await response.blob();
        const fileName = response.headers.get("X-File-Name") || "download";
        const containerDownload = new ContainerDownload(blob, fileName);
        return containerDownload;
    }

    /**
     * 
     * @param {Method} progressCallbackMethod 
     * @param {Number} loaded 
     * @param {Number} total 
     */
    callProgressCallbackMethod(progressCallbackMethod, loaded, total) {
        if (progressCallbackMethod) {
            progressCallbackMethod.call(loaded, total);
        }
    }
}